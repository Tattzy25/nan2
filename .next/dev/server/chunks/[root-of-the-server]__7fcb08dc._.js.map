{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/relay/Downloads/nano-main/nano-main/app/api/generate-image/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { generateText } from \"ai\"\nimport { createGateway } from \"@ai-sdk/gateway\"\n\nexport const dynamic = \"force-dynamic\"\n\nconst MAX_PROMPT_LENGTH = 5000\nconst MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB\nconst ALLOWED_IMAGE_TYPES = [\"image/jpeg\", \"image/png\", \"image/webp\", \"image/gif\"]\n\ninterface GenerateImageResponse {\n  url: string\n  prompt: string\n  description?: string\n}\n\ninterface ErrorResponse {\n  error: string\n  message?: string\n  details?: string\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const apiKey = process.env.AI_GATEWAY_API_KEY\n\n    if (!apiKey) {\n      return NextResponse.json<ErrorResponse>(\n        {\n          error: \"Configuration error\",\n          details: \"No AI Gateway API key configured. Please add AI_GATEWAY_API_KEY to environment variables.\",\n        },\n        { status: 500 },\n      )\n    }\n\n    const formData = await request.formData()\n    const mode = formData.get(\"mode\") as string\n    const prompt = formData.get(\"prompt\") as string\n    const aspectRatio = formData.get(\"aspectRatio\") as string\n\n    if (!mode) {\n      return NextResponse.json<ErrorResponse>({ error: \"Mode is required\" }, { status: 400 })\n    }\n\n    if (!prompt?.trim()) {\n      return NextResponse.json<ErrorResponse>({ error: \"Prompt is required\" }, { status: 400 })\n    }\n\n    if (prompt.length > MAX_PROMPT_LENGTH) {\n      return NextResponse.json<ErrorResponse>(\n        { error: `Prompt too long. Maximum ${MAX_PROMPT_LENGTH} characters allowed.` },\n        { status: 400 },\n      )\n    }\n\n    const geminiAspectRatioMap: Record<string, string> = {\n      portrait: \"9:16\",\n      landscape: \"16:9\",\n      wide: \"21:9\",\n      \"4:3\": \"4:3\",\n      \"3:4\": \"3:4\",\n      \"3:2\": \"3:2\",\n      \"2:3\": \"2:3\",\n      \"5:4\": \"5:4\",\n      \"4:5\": \"4:5\",\n      square: \"1:1\",\n    }\n\n    const geminiAspectRatio = geminiAspectRatioMap[aspectRatio] || \"1:1\"\n\n    const gateway = createGateway({\n      apiKey: apiKey,\n    })\n\n    const model = gateway(\"google/gemini-3-pro-image\")\n\n    if (mode === \"text-to-image\") {\n      const imageGenerationPrompt = `Generate a high-quality image based on this description: ${prompt}. The image should be visually appealing and match the description as closely as possible.`\n\n      const result = await generateText({\n        model,\n        prompt: imageGenerationPrompt,\n        providerOptions: {\n          google: {\n            responseModalities: [\"IMAGE\"],\n            imageConfig: {\n              aspectRatio: geminiAspectRatio,\n            },\n          },\n        },\n      })\n\n      const imageFiles = result.files?.filter((f) => f.mediaType?.startsWith(\"image/\")) || []\n\n      if (imageFiles.length === 0) {\n        return NextResponse.json<ErrorResponse>(\n          { error: \"No image generated\", details: \"The model did not return any images\" },\n          { status: 500 },\n        )\n      }\n\n      const firstImage = imageFiles[0]\n      const imageUrl = `data:${firstImage.mediaType};base64,${firstImage.base64}`\n\n      return NextResponse.json<GenerateImageResponse>({\n        url: imageUrl,\n        prompt: prompt,\n        description: result.text || \"\",\n      })\n    } else if (mode === \"image-editing\") {\n      const image1 = formData.get(\"image1\") as File\n      const image2 = formData.get(\"image2\") as File\n      const image1Url = formData.get(\"image1Url\") as string\n      const image2Url = formData.get(\"image2Url\") as string\n\n      const hasImage1 = image1 || image1Url\n      const hasImage2 = image2 || image2Url\n\n      if (!hasImage1) {\n        return NextResponse.json<ErrorResponse>(\n          { error: \"At least one image is required for editing mode\" },\n          { status: 400 },\n        )\n      }\n\n      if (image1) {\n        if (image1.size > MAX_FILE_SIZE) {\n          return NextResponse.json<ErrorResponse>(\n            { error: `Image 1 too large. Maximum ${MAX_FILE_SIZE / 1024 / 1024}MB allowed.` },\n            { status: 400 },\n          )\n        }\n        if (!ALLOWED_IMAGE_TYPES.includes(image1.type)) {\n          return NextResponse.json<ErrorResponse>(\n            { error: \"Image 1 has invalid format. Allowed: JPEG, PNG, WebP, GIF\" },\n            { status: 400 },\n          )\n        }\n      }\n\n      if (image2) {\n        if (image2.size > MAX_FILE_SIZE) {\n          return NextResponse.json<ErrorResponse>(\n            { error: `Image 2 too large. Maximum ${MAX_FILE_SIZE / 1024 / 1024}MB allowed.` },\n            { status: 400 },\n          )\n        }\n        if (!ALLOWED_IMAGE_TYPES.includes(image2.type)) {\n          return NextResponse.json<ErrorResponse>(\n            { error: \"Image 2 has invalid format. Allowed: JPEG, PNG, WebP, GIF\" },\n            { status: 400 },\n          )\n        }\n      }\n\n      const convertToDataUrl = async (source: File | string): Promise<string> => {\n        if (typeof source === \"string\") {\n          const response = await fetch(source)\n          const arrayBuffer = await response.arrayBuffer()\n          const buffer = Buffer.from(arrayBuffer)\n          const base64 = buffer.toString(\"base64\")\n          const contentType = response.headers.get(\"content-type\") || \"image/jpeg\"\n          return `data:${contentType};base64,${base64}`\n        } else {\n          const arrayBuffer = await source.arrayBuffer()\n          const buffer = Buffer.from(arrayBuffer)\n          const base64 = buffer.toString(\"base64\")\n          return `data:${source.type};base64,${base64}`\n        }\n      }\n\n      const image1DataUrl = await convertToDataUrl(hasImage1 ? image1 || image1Url : \"\")\n      const image2DataUrl = hasImage2 ? await convertToDataUrl(image2 || image2Url) : null\n\n      const messageParts: Array<{ type: \"text\" | \"image\"; text?: string; image?: string }> = []\n\n      messageParts.push({ type: \"image\", image: image1DataUrl })\n      if (image2DataUrl) {\n        messageParts.push({ type: \"image\", image: image2DataUrl })\n      }\n\n      const editingPrompt = hasImage2\n        ? `${prompt}. Combine these two images creatively while following the instructions.`\n        : `${prompt}. Edit or transform this image based on the instructions.`\n\n      messageParts.push({ type: \"text\", text: editingPrompt })\n\n      const result = await generateText({\n        model,\n        messages: [\n          {\n            role: \"user\",\n            // @ts-ignore - Type issue with content parts\n            content: messageParts,\n          },\n        ],\n        providerOptions: {\n          google: {\n            responseModalities: [\"IMAGE\"],\n            imageConfig: {\n              aspectRatio: geminiAspectRatio,\n            },\n          },\n        },\n      })\n\n      const imageFiles = result.files?.filter((f) => f.mediaType?.startsWith(\"image/\")) || []\n\n      if (imageFiles.length === 0) {\n        return NextResponse.json<ErrorResponse>(\n          { error: \"No image generated\", details: \"The model did not return any images\" },\n          { status: 500 },\n        )\n      }\n\n      const firstImage = imageFiles[0]\n      const imageUrl = `data:${firstImage.mediaType};base64,${firstImage.base64}`\n\n      return NextResponse.json<GenerateImageResponse>({\n        url: imageUrl,\n        prompt: editingPrompt,\n        description: result.text || \"\",\n      })\n    } else {\n      return NextResponse.json<ErrorResponse>(\n        { error: \"Invalid mode\", details: \"Mode must be 'text-to-image' or 'image-editing'\" },\n        { status: 400 },\n      )\n    }\n  } catch (error) {\n    console.error(\"Error in generate-image route:\", error)\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error occurred\"\n\n    return NextResponse.json<ErrorResponse>(\n      {\n        error: \"Failed to generate image\",\n        details: errorMessage,\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}